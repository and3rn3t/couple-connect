name: ğŸ”’ Branch Protection Status Checks

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

# Minimal permissions for security
permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  NODE_VERSION: '20'
  FORCE_COLOR: 3
  CI: true

jobs:
  # ğŸ§ª Tests & Code Quality Check
  tests-quality:
    name: ğŸ§ª Tests & Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Type check
        run: npm run type-check

      - name: ğŸ§¹ Lint
        run: npm run lint

      - name: ğŸ§ª Run tests
        run: npm run test

      - name: ğŸ“Š Test coverage
        run: npm run test:coverage

  # ğŸ“± Mobile Performance Check
  mobile-performance:
    name: ğŸ“± Mobile Performance
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build
        run: npm run build

      - name: ğŸ“± Mobile performance check
        run: npm run perf:mobile

      - name: ğŸ“Š Bundle analysis
        run: npm run build:analyze

  # ğŸ”’ Security Analysis Check
  security-analysis:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”’ Security audit
        run: npm audit --audit-level high
        continue-on-error: false

      - name: ğŸ” Dependency check
        run: npm run security:check
        continue-on-error: false

  # ğŸš¨ Infinite Loop Detection Check
  infinite-loop-detection:
    name: ğŸš¨ Infinite Loop Detection
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸš¨ Run infinite loop detection
        run: node scripts/check-infinite-loops.js
        continue-on-error: false

      - name: âœ… Validate detection results
        run: |
          if [ -f infinite-loop-results.json ]; then
            echo "Detection completed successfully"
            cat infinite-loop-results.json
          else
            echo "No critical issues detected"
          fi

  # ğŸ“Š Bundle Analysis Check
  bundle-analysis:
    name: ğŸ“Š Bundle Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build
        run: npm run build

      - name: ğŸ“Š Analyze bundle
        run: npm run build:analyze

      - name: ğŸ“± Check bundle size limits
        run: |
          if [ -f dist/stats.json ]; then
            echo "Bundle analysis completed"
            # Add bundle size validation logic here
          fi

  # ğŸ” TypeScript Check
  typescript-check:
    name: ğŸ” TypeScript Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” TypeScript compilation
        run: npx tsc --noEmit

      - name: ğŸ” Type check with strict mode
        run: npm run type-check

  # ğŸ§¹ Lint & Format Check
  lint-format:
    name: ğŸ§¹ Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§¹ ESLint check
        run: npm run lint

      - name: ğŸ¨ Format check
        run: npm run format:check

      - name: ğŸ“ Markdown lint
        run: npm run lint:md

  # ğŸ¯ Overall Status Check
  branch-protection-status:
    name: ğŸ¯ Branch Protection Status
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs:
      - tests-quality
      - mobile-performance
      - security-analysis
      - infinite-loop-detection
      - bundle-analysis
      - typescript-check
      - lint-format
    if: always()
    steps:
      - name: ğŸ“Š Check all required status
        run: |
          echo "All required checks completed"
          echo "Tests & Code Quality: ${{ needs.tests-quality.result }}"
          echo "Mobile Performance: ${{ needs.mobile-performance.result }}"
          echo "Security Analysis: ${{ needs.security-analysis.result }}"
          echo "Infinite Loop Detection: ${{ needs.infinite-loop-detection.result }}"
          echo "Bundle Analysis: ${{ needs.bundle-analysis.result }}"
          echo "TypeScript Check: ${{ needs.typescript-check.result }}"
          echo "Lint & Format: ${{ needs.lint-format.result }}"

      - name: âœ… All checks passed
        if: needs.tests-quality.result == 'success' && needs.mobile-performance.result == 'success' && needs.security-analysis.result == 'success' && needs.infinite-loop-detection.result == 'success' && needs.bundle-analysis.result == 'success' && needs.typescript-check.result == 'success' && needs.lint-format.result == 'success'
        run: echo "ğŸ‰ All branch protection checks passed!"

      - name: âŒ Some checks failed
        if: needs.tests-quality.result != 'success' || needs.mobile-performance.result != 'success' || needs.security-analysis.result != 'success' || needs.infinite-loop-detection.result != 'success' || needs.bundle-analysis.result != 'success' || needs.typescript-check.result != 'success' || needs.lint-format.result != 'success'
        run: |
          echo "âŒ Some required checks failed. Pull request cannot be merged."
          exit 1
